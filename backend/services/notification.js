const nodemailer = require('nodemailer');\nconst twilio = require('twilio');\nconst axios = require('axios');\nconst User = require('../models/User');\nconst Invoice = require('../models/Invoice');\nconst Transaction = require('../models/Transaction');\n\nclass NotificationService {\n  constructor() {\n    // Email configuration\n    this.emailTransporter = nodemailer.createTransporter({\n      host: process.env.SMTP_HOST,\n      port: process.env.SMTP_PORT,\n      secure: true,\n      auth: {\n        user: process.env.SMTP_USER,\n        pass: process.env.SMTP_PASS\n      }\n    });\n\n    // SMS configuration (Twilio)\n    this.smsClient = twilio(\n      process.env.TWILIO_ACCOUNT_SID,\n      process.env.TWILIO_AUTH_TOKEN\n    );\n\n    // WhatsApp configuration\n    this.whatsappApiUrl = process.env.WHATSAPP_API_URL;\n    this.whatsappApiKey = process.env.WHATSAPP_API_KEY;\n\n    // Push notification configuration\n    this.fcmServerKey = process.env.FCM_SERVER_KEY;\n\n    // Notification templates\n    this.templates = {\n      email: {\n        invoice_uploaded: {\n          subject: 'Invoice Uploaded Successfully - ReturnX',\n          template: 'invoice-uploaded.html'\n        },\n        invoice_funded: {\n          subject: 'Your Invoice has been Funded! - ReturnX',\n          template: 'invoice-funded.html'\n        },\n        investment_opportunity: {\n          subject: 'New Investment Opportunity - ReturnX',\n          template: 'investment-opportunity.html'\n        },\n        payment_received: {\n          subject: 'Payment Received - Invoice Completed - ReturnX',\n          template: 'payment-received.html'\n        },\n        roi_credited: {\n          subject: 'ROI Credited to Your Account - ReturnX',\n          template: 'roi-credited.html'\n        },\n        payment_overdue: {\n          subject: 'Payment Overdue - Immediate Action Required - ReturnX',\n          template: 'payment-overdue.html'\n        }\n      },\n      sms: {\n        invoice_funded: 'Great news! Your invoice #{invoiceNumber} has been funded with â‚¹{amount}. Funds will be credited within 24 hours. - ReturnX',\n        payment_due: 'Reminder: Payment of â‚¹{amount} for invoice #{invoiceNumber} is due on {dueDate}. Please pay to avoid penalties. - ReturnX',\n        roi_credited: 'ROI of â‚¹{amount} has been credited to your ReturnX wallet for invoice #{invoiceNumber}. Happy investing!',\n        payment_overdue: 'URGENT: Payment of â‚¹{amount} for invoice #{invoiceNumber} is overdue. Please pay immediately to avoid legal action. - ReturnX'\n      },\n      whatsapp: {\n        investment_opportunity: {\n          template: 'investment_opportunity',\n          components: [\n            {\n              type: 'header',\n              parameters: [{ type: 'text', text: 'New Investment Opportunity' }]\n            },\n            {\n              type: 'body',\n              parameters: [\n                { type: 'text', text: '{{invoiceAmount}}' },\n                { type: 'text', text: '{{expectedROI}}' },\n                { type: 'text', text: '{{riskScore}}' },\n                { type: 'text', text: '{{daysToMaturity}}' }\n              ]\n            }\n          ]\n        }\n      },\n      push: {\n        invoice_funded: {\n          title: 'Invoice Funded! ðŸŽ‰',\n          body: 'Your invoice #{invoiceNumber} has been funded with â‚¹{amount}',\n          icon: 'funding-success',\n          action: 'view_invoice'\n        },\n        new_opportunity: {\n          title: 'New Investment Opportunity ðŸ’°',\n          body: 'â‚¹{amount} invoice with {roi}% ROI available',\n          icon: 'investment-opportunity',\n          action: 'view_marketplace'\n        }\n      }\n    };\n  }\n\n  // Main notification dispatcher\n  async notify(userId, eventType, data, channels = ['email', 'sms', 'push']) {\n    try {\n      const user = await User.findById(userId);\n      if (!user) {\n        throw new Error('User not found');\n      }\n\n      const notifications = [];\n\n      // Send notifications through specified channels\n      if (channels.includes('email') && user.email) {\n        notifications.push(this.sendEmail(user, eventType, data));\n      }\n\n      if (channels.includes('sms') && user.phone) {\n        notifications.push(this.sendSMS(user, eventType, data));\n      }\n\n      if (channels.includes('whatsapp') && user.whatsappNumber) {\n        notifications.push(this.sendWhatsApp(user, eventType, data));\n      }\n\n      if (channels.includes('push') && user.fcmToken) {\n        notifications.push(this.sendPushNotification(user, eventType, data));\n      }\n\n      await Promise.allSettled(notifications);\n\n      // Log notification\n      await this.logNotification(userId, eventType, data, channels);\n\n    } catch (error) {\n      console.error('Notification failed:', error);\n      throw error;\n    }\n  }\n\n  // Email notifications\n  async sendEmail(user, eventType, data) {\n    const template = this.templates.email[eventType];\n    if (!template) {\n      throw new Error(`Email template not found for event: ${eventType}`);\n    }\n\n    const emailContent = await this.renderEmailTemplate(template.template, data);\n\n    const mailOptions = {\n      from: `\"ReturnX\" <${process.env.SMTP_FROM_EMAIL}>`,\n      to: user.email,\n      subject: this.interpolateString(template.subject, data),\n      html: emailContent,\n      attachments: data.attachments || []\n    };\n\n    return await this.emailTransporter.sendMail(mailOptions);\n  }\n\n  // SMS notifications\n  async sendSMS(user, eventType, data) {\n    const template = this.templates.sms[eventType];\n    if (!template) {\n      throw new Error(`SMS template not found for event: ${eventType}`);\n    }\n\n    const message = this.interpolateString(template, data);\n\n    return await this.smsClient.messages.create({\n      body: message,\n      from: process.env.TWILIO_PHONE_NUMBER,\n      to: user.phone\n    });\n  }\n\n  // WhatsApp notifications\n  async sendWhatsApp(user, eventType, data) {\n    const template = this.templates.whatsapp[eventType];\n    if (!template) {\n      throw new Error(`WhatsApp template not found for event: ${eventType}`);\n    }\n\n    const payload = {\n      messaging_product: 'whatsapp',\n      to: user.whatsappNumber,\n      type: 'template',\n      template: {\n        name: template.template,\n        language: { code: 'en' },\n        components: template.components.map(component => ({\n          ...component,\n          parameters: component.parameters?.map(param => ({\n            ...param,\n            text: this.interpolateString(param.text, data)\n          }))\n        }))\n      }\n    };\n\n    return await axios.post(this.whatsappApiUrl, payload, {\n      headers: {\n        'Authorization': `Bearer ${this.whatsappApiKey}`,\n        'Content-Type': 'application/json'\n      }\n    });\n  }\n\n  // Push notifications\n  async sendPushNotification(user, eventType, data) {\n    const template = this.templates.push[eventType];\n    if (!template) {\n      throw new Error(`Push template not found for event: ${eventType}`);\n    }\n\n    const payload = {\n      to: user.fcmToken,\n      notification: {\n        title: this.interpolateString(template.title, data),\n        body: this.interpolateString(template.body, data),\n        icon: template.icon,\n        click_action: template.action\n      },\n      data: {\n        eventType,\n        ...data\n      }\n    };\n\n    return await axios.post('https://fcm.googleapis.com/fcm/send', payload, {\n      headers: {\n        'Authorization': `key=${this.fcmServerKey}`,\n        'Content-Type': 'application/json'\n      }\n    });\n  }\n\n  // Bulk notifications for investors\n  async notifyInvestors(eventType, data, filters = {}) {\n    const investors = await User.find({\n      role: 'investor',\n      isActive: true,\n      notificationPreferences: { $ne: false },\n      ...filters\n    });\n\n    const notifications = investors.map(investor => \n      this.notify(investor._id, eventType, data, ['email', 'push'])\n    );\n\n    return await Promise.allSettled(notifications);\n  }\n\n  // Specific notification methods\n  async notifyInvoiceUploaded(invoiceId) {\n    const invoice = await Invoice.findById(invoiceId).populate('smeId');\n    \n    await this.notify(invoice.smeId._id, 'invoice_uploaded', {\n      invoiceNumber: invoice.invoiceNumber,\n      amount: invoice.amount.toLocaleString(),\n      status: invoice.status,\n      uploadDate: invoice.createdAt.toLocaleDateString()\n    });\n  }\n\n  async notifyInvoiceFunded(invoiceId) {\n    const invoice = await Invoice.findById(invoiceId)\n      .populate('smeId')\n      .populate('investorId');\n    \n    const fundingAmount = await Transaction.aggregate([\n      { $match: { invoiceId: invoice._id, type: 'funding', status: 'completed' } },\n      { $group: { _id: null, total: { $sum: '$amount' } } }\n    ]);\n\n    // Notify SME\n    await this.notify(invoice.smeId._id, 'invoice_funded', {\n      invoiceNumber: invoice.invoiceNumber,\n      amount: fundingAmount[0]?.total.toLocaleString() || '0',\n      fundedDate: new Date().toLocaleDateString()\n    });\n  }\n\n  async notifyNewOpportunity(invoiceId) {\n    const invoice = await Invoice.findById(invoiceId)\n      .populate('smeId')\n      .populate('customerId');\n    \n    const discountRate = 0.1; // 10% default\n    const discountedAmount = Math.floor(invoice.amount * (1 - discountRate));\n    const expectedROI = ((invoice.amount - discountedAmount) / discountedAmount * 100).toFixed(1);\n    const daysToMaturity = Math.ceil((new Date(invoice.dueDate) - new Date()) / (1000 * 60 * 60 * 24));\n\n    await this.notifyInvestors('investment_opportunity', {\n      invoiceNumber: invoice.invoiceNumber,\n      invoiceAmount: invoice.amount.toLocaleString(),\n      discountedAmount: discountedAmount.toLocaleString(),\n      expectedROI,\n      riskScore: invoice.riskScore,\n      daysToMaturity,\n      smeName: invoice.smeId.name,\n      customerName: invoice.customerId.name\n    });\n  }\n\n  async notifyPaymentReceived(invoiceId) {\n    const invoice = await Invoice.findById(invoiceId);\n    const investors = await Transaction.find({\n      invoiceId,\n      type: 'funding',\n      status: 'completed'\n    }).populate('fromUserId');\n\n    // Notify each investor\n    for (const investment of investors) {\n      const roi = investment.expectedReturn - investment.amount;\n      \n      await this.notify(investment.fromUserId._id, 'roi_credited', {\n        invoiceNumber: invoice.invoiceNumber,\n        investedAmount: investment.amount.toLocaleString(),\n        roiAmount: roi.toLocaleString(),\n        totalReturn: investment.expectedReturn.toLocaleString(),\n        completedDate: new Date().toLocaleDateString()\n      });\n    }\n  }\n\n  async notifyPaymentOverdue(invoiceId) {\n    const invoice = await Invoice.findById(invoiceId)\n      .populate('customerId')\n      .populate('smeId');\n    \n    const daysOverdue = Math.ceil((new Date() - new Date(invoice.dueDate)) / (1000 * 60 * 60 * 24));\n\n    // Notify customer\n    await this.notify(invoice.customerId._id, 'payment_overdue', {\n      invoiceNumber: invoice.invoiceNumber,\n      amount: invoice.amount.toLocaleString(),\n      dueDate: invoice.dueDate.toLocaleDateString(),\n      daysOverdue,\n      smeName: invoice.smeId.name\n    }, ['email', 'sms', 'whatsapp']);\n\n    // Notify SME\n    await this.notify(invoice.smeId._id, 'payment_overdue', {\n      invoiceNumber: invoice.invoiceNumber,\n      amount: invoice.amount.toLocaleString(),\n      daysOverdue,\n      customerName: invoice.customerId.name\n    });\n  }\n\n  // Scheduled notifications\n  async sendPaymentReminders() {\n    const upcomingDueInvoices = await Invoice.find({\n      status: 'funded',\n      dueDate: {\n        $gte: new Date(),\n        $lte: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000) // Next 3 days\n      }\n    });\n\n    for (const invoice of upcomingDueInvoices) {\n      await this.notify(invoice.customerId, 'payment_due', {\n        invoiceNumber: invoice.invoiceNumber,\n        amount: invoice.amount.toLocaleString(),\n        dueDate: invoice.dueDate.toLocaleDateString()\n      }, ['email', 'sms']);\n    }\n  }\n\n  async sendOverdueNotifications() {\n    const overdueInvoices = await Invoice.find({\n      status: 'funded',\n      dueDate: { $lt: new Date() }\n    });\n\n    for (const invoice of overdueInvoices) {\n      await this.notifyPaymentOverdue(invoice._id);\n    }\n  }\n\n  // Utility methods\n  interpolateString(template, data) {\n    return template.replace(/\\{([^}]+)\\}/g, (match, key) => {\n      return data[key] || match;\n    });\n  }\n\n  async renderEmailTemplate(templateName, data) {\n    // In production, use a proper template engine like Handlebars\n    // For now, return a simple HTML template\n    return `\n      <html>\n        <body style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n          <div style=\"background: linear-gradient(135deg, #4ade80 0%, #f59e0b 100%); padding: 20px; text-align: center;\">\n            <h1 style=\"color: white; margin: 0;\">ReturnX</h1>\n          </div>\n          <div style=\"padding: 20px;\">\n            <h2>Invoice Notification</h2>\n            <p>Dear User,</p>\n            <p>This is to inform you about your invoice activity.</p>\n            <div style=\"background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0;\">\n              <strong>Invoice Details:</strong><br>\n              Invoice Number: ${data.invoiceNumber || 'N/A'}<br>\n              Amount: â‚¹${data.amount || 'N/A'}<br>\n              Status: ${data.status || 'N/A'}\n            </div>\n            <p>Thank you for using ReturnX!</p>\n          </div>\n          <div style=\"background: #333; color: white; padding: 10px; text-align: center; font-size: 12px;\">\n            Â© 2024 ReturnX. All rights reserved.\n          </div>\n        </body>\n      </html>\n    `;\n  }\n\n  async logNotification(userId, eventType, data, channels) {\n    // Log notification for analytics and debugging\n    console.log(`Notification sent: ${eventType} to user ${userId} via ${channels.join(', ')}`);\n    \n    // In production, store in database for audit trail\n    // await NotificationLog.create({ userId, eventType, data, channels, sentAt: new Date() });\n  }\n}\n\nmodule.exports = {\n  notificationService: new NotificationService()\n};